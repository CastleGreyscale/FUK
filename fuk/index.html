<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FUK Generation Pipeline v1.3</title>
  
  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- React and Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Simple Icons (inline SVG components)
    const Camera = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );
    
    const Film = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
      </svg>
    );
    
    const Image = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    );
    
    const Clock = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    
    const Settings = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );
    
    const Zap = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
    );
    
    const Loader = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );
    
    const CheckCircle = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    
    const Download = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
    );
    
    const RotateCcw = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );
    
    // API base URL
    const API_URL = 'http://localhost:8000/api';
    
    // Tab Button Component
    const TabButton = ({ active, onClick, icon, label, badge }) => (
      <button
        onClick={onClick}
        className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-colors ${
          active
            ? 'border-purple-500 text-purple-400'
            : 'border-transparent text-gray-400 hover:text-gray-300'
        }`}
      >
        {icon}
        <span className="font-medium">{label}</span>
        {badge > 0 && (
          <span className="px-2 py-0.5 bg-purple-500 text-white text-xs rounded-full">
            {badge}
          </span>
        )}
      </button>
    );
    
    // Image Generation Tab
    const ImageGenerationTab = ({ config }) => {
      const defaults = config?.defaults || {};
      
      const [formData, setFormData] = useState({
        prompt: '',
        model: 'qwen_image',
        negative_prompt: defaults.negative_prompt || '',
        width: defaults.image_size?.[0] || 1024,
        height: defaults.image_size?.[1] || 1024,
        steps: defaults.infer_steps || 20,
        guidance_scale: defaults.guidance_scale || 2.1,
        flow_shift: defaults.flow_shift || 2.1,
        seed: null,
        lora: null,
        lora_multiplier: defaults.lora_multiplier || 1.0,
        blocks_to_swap: defaults.blocks_to_swap || 10,
        output_format: 'png'
      });
      
      const [generating, setGenerating] = useState(false);
      const [generationId, setGenerationId] = useState(null);
      const [progress, setProgress] = useState(null);
      const [result, setResult] = useState(null);
      const [startTime, setStartTime] = useState(null);
      const [elapsedSeconds, setElapsedSeconds] = useState(0);
      
      // Load saved state from localStorage on mount
      useEffect(() => {
        console.log('=== FUK UI v1.3 Loaded ===');
        console.log('Features: Real-time step tracking, Persistent state, Auto-save settings');
        console.log('Controls: Flow Shift, Negative Prompt, LoRA, Blocks to Swap, Time Tracking');
        
        // Load saved form data
        const saved = localStorage.getItem('fuk_form_data');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            console.log('Loaded saved settings:', parsed);
            setFormData(parsed);
          } catch (e) {
            console.error('Failed to load saved settings:', e);
          }
        }
      }, []);
      
      // Save form data to localStorage whenever it changes
      useEffect(() => {
        if (Object.keys(formData).length > 0) {
          localStorage.setItem('fuk_form_data', JSON.stringify(formData));
          console.log('Saved settings to localStorage');
        }
      }, [formData]);
      
      // Monitor progress
      useEffect(() => {
        if (!generationId) return;
        
        const eventSource = new EventSource(`http://localhost:8000/api/progress/${generationId}`);
        
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log('Progress update:', data);
          setProgress(data);
          
          if (data.status === 'complete') {
            console.log('Generation complete, outputs:', data.outputs);
            setResult(data);
            setGenerating(false);
            eventSource.close();
          } else if (data.status === 'failed') {
            alert('Generation failed: ' + (data.error || 'Unknown error'));
            setGenerating(false);
            setStartTime(null);
            eventSource.close();
          } else if (data.status === 'cancelled') {
            setGenerating(false);
            setStartTime(null);
            eventSource.close();
          }
        };
        
        eventSource.onerror = (error) => {
          console.error('SSE error:', error);
          eventSource.close();
        };
        
        return () => eventSource.close();
      }, [generationId]);
      
      // Timer for elapsed time
      useEffect(() => {
        if (!startTime || !generating) {
          return;
        }
        
        const interval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          setElapsedSeconds(elapsed);
        }, 1000);
        
        return () => clearInterval(interval);
      }, [startTime, generating]);
      
      const handleGenerate = async () => {
        setGenerating(true);
        setProgress(null);
        setResult(null);
        setStartTime(Date.now());
        setElapsedSeconds(0);
        
        console.log('Starting generation with params:', formData);
        
        try {
          const res = await fetch('http://localhost:8000/api/generate/image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          if (!res.ok) {
            throw new Error(`Server error: ${res.status}`);
          }
          
          const data = await res.json();
          console.log('Generation started:', data);
          setGenerationId(data.generation_id);
        } catch (error) {
          console.error('Generation failed:', error);
          setGenerating(false);
          setStartTime(null);
          alert('Failed to start generation: ' + error.message);
        }
      };
      
      const handleCancel = async () => {
        if (!generationId) return;
        
        try {
          const res = await fetch(`http://localhost:8000/api/cancel/${generationId}`, {
            method: 'POST'
          });
          
          const data = await res.json();
          console.log('Cancelled:', data);
          
          setGenerating(false);
          setStartTime(null);
          setProgress(null);
        } catch (error) {
          console.error('Cancel failed:', error);
        }
      };
      
      const handleResetDefaults = async () => {
        if (confirm('Reset all settings to defaults? This will clear your saved preferences.')) {
          try {
            // Clear localStorage
            localStorage.removeItem('fuk_form_data');
            
            // Reload defaults from backend
            const res = await fetch('http://localhost:8000/api/config/defaults');
            const defaults = await res.json();
            
            setFormData({
              prompt: '',
              model: 'qwen_image',
              width: defaults.image_size?.[0] || 1024,
              height: defaults.image_size?.[1] || 1024,
              steps: defaults.infer_steps || 20,
              guidance_scale: defaults.guidance_scale || 2.1,
              flow_shift: defaults.flow_shift || 2.1,
              negative_prompt: defaults.negative_prompt || '',
              seed: null,
              lora: null,
              lora_multiplier: defaults.lora_multiplier || 1.0,
              blocks_to_swap: defaults.blocks_to_swap || 10,
              output_format: 'png'
            });
            
            console.log('Reset to defaults');
          } catch (error) {
            console.error('Failed to reset defaults:', error);
          }
        }
      };
      
      // Format seconds to MM:SS
      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };
      
      return (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Left: Controls */}
          <div className="space-y-6">
            <div className="bg-gray-800/50 rounded-lg border border-gray-700 p-6">
              <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <Settings className="w-5 h-5" />
                Generation Parameters
              </h2>
              
              <div className="space-y-4">
                {/* Prompt */}
                <div>
                  <label className="block text-sm font-medium mb-2">Prompt</label>
                  <textarea
                    value={formData.prompt}
                    onChange={(e) => setFormData({ ...formData, prompt: e.target.value })}
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-white"
                    rows={3}
                    placeholder="A noir film style image. An apple on a wooden table."
                  />
                </div>
                
                {/* Dimensions */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Width</label>
                    <input
                      type="number"
                      value={formData.width}
                      onChange={(e) => setFormData({ ...formData, width: parseInt(e.target.value) })}
                      className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
                      step={64}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Height</label>
                    <input
                      type="number"
                      value={formData.height}
                      onChange={(e) => setFormData({ ...formData, height: parseInt(e.target.value) })}
                      className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
                      step={64}
                    />
                  </div>
                </div>
                
                {/* Steps */}
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Steps: {formData.steps}
                  </label>
                  <input
                    type="range"
                    value={formData.steps}
                    onChange={(e) => setFormData({ ...formData, steps: parseInt(e.target.value) })}
                    min={10}
                    max={50}
                    className="w-full"
                  />
                </div>
                
                {/* Guidance Scale */}
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Guidance Scale: {formData.guidance_scale.toFixed(1)}
                  </label>
                  <input
                    type="range"
                    value={formData.guidance_scale}
                    onChange={(e) => setFormData({ ...formData, guidance_scale: parseFloat(e.target.value) })}
                    min={1}
                    max={10}
                    step={0.1}
                    className="w-full"
                  />
                  <p className="text-xs text-gray-400 mt-1">
                    Lower = softer, Higher = stronger adherence to prompt
                  </p>
                </div>
                
                {/* Flow Shift */}
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Flow Shift: {formData.flow_shift.toFixed(1)}
                  </label>
                  <input
                    type="range"
                    value={formData.flow_shift}
                    onChange={(e) => setFormData({ ...formData, flow_shift: parseFloat(e.target.value) })}
                    min={1}
                    max={5}
                    step={0.1}
                    className="w-full"
                  />
                  <p className="text-xs text-gray-400 mt-1">
                    Lower (2.0-2.2) = more natural, Higher (3.0+) = more detail
                  </p>
                </div>
                
                {/* Negative Prompt */}
                <div>
                  <label className="block text-sm font-medium mb-2">Negative Prompt</label>
                  <textarea
                    value={formData.negative_prompt}
                    onChange={(e) => setFormData({ ...formData, negative_prompt: e.target.value })}
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-white text-sm"
                    rows={2}
                    placeholder="What to avoid in the generation..."
                  />
                </div>
                
                {/* Seed */}
                <div>
                  <label className="block text-sm font-medium mb-2">Seed (optional)</label>
                  <input
                    type="number"
                    value={formData.seed || ''}
                    onChange={(e) => setFormData({ ...formData, seed: e.target.value ? parseInt(e.target.value) : null })}
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
                    placeholder="Random"
                  />
                </div>
                
                {/* LoRA Selection */}
                {config?.models?.loras && config.models.loras.length > 0 && (
                  <div>
                    <label className="block text-sm font-medium mb-2">LoRA</label>
                    <select
                      value={formData.lora || ''}
                      onChange={(e) => setFormData({ ...formData, lora: e.target.value || null })}
                      className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
                    >
                      <option value="">None</option>
                      {config.models.loras.map(lora => (
                        <option key={lora} value={lora}>{lora}</option>
                      ))}
                    </select>
                  </div>
                )}
                
                {/* LoRA Strength */}
                {formData.lora && (
                  <div>
                    <label className="block text-sm font-medium mb-2">
                      LoRA Strength: {formData.lora_multiplier.toFixed(1)}
                    </label>
                    <input
                      type="range"
                      value={formData.lora_multiplier}
                      onChange={(e) => setFormData({ ...formData, lora_multiplier: parseFloat(e.target.value) })}
                      min={0}
                      max={2}
                      step={0.1}
                      className="w-full"
                    />
                  </div>
                )}
                
                {/* Blocks to Swap (VRAM Management) */}
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Blocks to Swap: {formData.blocks_to_swap}
                  </label>
                  <input
                    type="range"
                    value={formData.blocks_to_swap}
                    onChange={(e) => setFormData({ ...formData, blocks_to_swap: parseInt(e.target.value) })}
                    min={0}
                    max={30}
                    step={1}
                    className="w-full"
                  />
                  <p className="text-xs text-gray-400 mt-1">
                    VRAM management: 0-10 (24GB), 10-20 (16GB), 20+ (12GB)
                  </p>
                </div>
                
                {/* Output Format */}
                <div>
                  <label className="block text-sm font-medium mb-2">Output Format</label>
                  <select
                    value={formData.output_format}
                    onChange={(e) => setFormData({ ...formData, output_format: e.target.value })}
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
                  >
                    <option value="png">PNG Only</option>
                    <option value="exr">EXR Only</option>
                    <option value="both">Both PNG + EXR</option>
                  </select>
                </div>
              </div>
              
              {/* Generate Button */}
              <button
                onClick={handleGenerate}
                disabled={generating || !formData.prompt}
                className="w-full mt-6 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:from-gray-600 disabled:to-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-all flex items-center justify-center gap-2"
              >
                {generating ? (
                  <>
                    <Loader className="w-5 h-5 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Zap className="w-5 h-5" />
                    Generate Image
                  </>
                )}
              </button>
              
              {/* Cancel Button */}
              {generating && (
                <button
                  onClick={handleCancel}
                  className="w-full mt-2 px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-all flex items-center justify-center gap-2"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  Cancel Generation
                </button>
              )}
              
              {/* Reset Button */}
              <button
                onClick={handleResetDefaults}
                disabled={generating}
                className="w-full mt-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50 rounded-lg text-sm flex items-center justify-center gap-2 transition-all"
              >
                <RotateCcw className="w-4 h-4" />
                Reset to Defaults
              </button>
              
              {/* Settings Saved Indicator */}
              <div className="text-xs text-gray-500 text-center mt-2">
                ðŸ’¾ Settings auto-saved
              </div>
            </div>
          </div>
          
          {/* Right: Preview & Progress */}
          <div className="space-y-6">
            {/* Error Display */}
            {progress && progress.status === 'failed' && (
              <div className="bg-red-900/20 border border-red-500/50 rounded-lg p-6">
                <div className="flex items-start gap-3">
                  <svg className="w-6 h-6 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div className="flex-1">
                    <h3 className="font-semibold text-red-400 mb-2">Generation Failed</h3>
                    <p className="text-sm text-gray-300 mb-3">{progress.error || 'Unknown error occurred'}</p>
                    <button
                      onClick={() => { setProgress(null); setGenerating(false); }}
                      className="text-sm text-gray-400 hover:text-white underline"
                    >
                      Dismiss
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* Cancelled Display */}
            {progress && progress.status === 'cancelled' && (
              <div className="bg-yellow-900/20 border border-yellow-500/50 rounded-lg p-6">
                <div className="flex items-start gap-3">
                  <svg className="w-6 h-6 text-yellow-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <div className="flex-1">
                    <h3 className="font-semibold text-yellow-400 mb-2">Generation Cancelled</h3>
                    <p className="text-sm text-gray-300 mb-3">
                      The generation was cancelled. Note: The backend process may still be running.
                    </p>
                    <button
                      onClick={() => { setProgress(null); }}
                      className="text-sm text-gray-400 hover:text-white underline"
                    >
                      Dismiss
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* Progress */}
            {progress && (
              <div className="bg-gray-800/50 rounded-lg border border-gray-700 p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-semibold">Generation Progress</h3>
                  <span className="text-sm text-gray-400 capitalize">{progress.phase}</span>
                </div>
                
                <div className="w-full bg-gray-700 rounded-full h-3 mb-3">
                  <div
                    className="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-300 flex items-center justify-center"
                    style={{ width: `${(progress.progress || 0) * 100}%` }}
                  >
                    {progress.progress > 0.1 && (
                      <span className="text-xs font-bold text-white">
                        {Math.round((progress.progress || 0) * 100)}%
                      </span>
                    )}
                  </div>
                </div>
                
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between text-gray-400">
                    <span>Status:</span>
                    <span className="text-white capitalize">{progress.status}</span>
                  </div>
                  
                  {progress.current_step && progress.total_steps && (
                    <div className="flex justify-between text-gray-400">
                      <span>Step:</span>
                      <span className="text-white">{progress.current_step} / {progress.total_steps}</span>
                    </div>
                  )}
                  
                  {/* Time Display */}
                  <div className="flex justify-between text-gray-400">
                    <span>Elapsed:</span>
                    <span className="text-white font-mono">{formatTime(elapsedSeconds)}</span>
                  </div>
                  
                  {progress.progress > 0.05 && progress.progress < 1 && (
                    <div className="flex justify-between text-gray-400">
                      <span>Est. Remaining:</span>
                      <span className="text-white font-mono">
                        {formatTime(Math.ceil(elapsedSeconds * (1 - progress.progress) / progress.progress))}
                      </span>
                    </div>
                  )}
                  
                  <div className="mt-3 p-3 bg-gray-900/50 rounded border border-gray-600">
                    <div className="flex items-start gap-2">
                      <Loader className="w-4 h-4 animate-spin text-purple-400 mt-0.5 flex-shrink-0" />
                      <div className="text-xs text-gray-300">
                        {progress.phase === 'initialization' && 'Setting up generation pipeline...'}
                        {progress.phase === 'generating' && 'Running diffusion model... This may take several minutes.'}
                        {progress.phase === 'denoising' && 'Running diffusion model... This may take several minutes.'}
                        {progress.phase === 'converting_to_exr' && 'Converting to EXR format...'}
                        {progress.phase === 'complete' && 'Finalizing...'}
                      </div>
                    </div>
                  </div>
                  
                  {generationId && (
                    <div className="text-xs text-gray-500 pt-2 border-t border-gray-700 mt-3">
                      ID: {generationId}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Result */}
            {result && result.outputs && result.outputs.png && (
              <div className="bg-gray-800/50 rounded-lg border border-gray-700 p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-semibold flex items-center gap-2">
                    <CheckCircle className="w-5 h-5 text-green-500" />
                    Generation Complete
                  </h3>
                  <span className="text-sm text-gray-400 font-mono">
                    {formatTime(elapsedSeconds)}
                  </span>
                </div>
                
                <div className="space-y-4">
                  <img
                    src={`http://localhost:8000/outputs/${result.outputs.png}`}
                    alt="Generated"
                    className="w-full rounded-lg border border-gray-700"
                    onError={(e) => {
                      console.error('Image failed to load:', e.target.src);
                      console.log('Result outputs:', result.outputs);
                    }}
                    onLoad={() => console.log('Image loaded successfully')}
                  />
                  
                  <div className="flex gap-2">
                    <a
                      href={`http://localhost:8000/outputs/${result.outputs.png}`}
                      download
                      className="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center gap-2"
                    >
                      <Download className="w-4 h-4" />
                      Download PNG
                    </a>
                    
                    {result.outputs.exr && (
                      <a
                        href={`http://localhost:8000/outputs/${result.outputs.exr}`}
                        download
                        className="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center gap-2"
                      >
                        <Download className="w-4 h-4" />
                        Download EXR
                      </a>
                    )}
                  </div>
                </div>
              </div>
            )}
            
            {/* Placeholder */}
            {!progress && !result && (
              <div className="bg-gray-800/50 rounded-lg border border-gray-700 border-dashed p-12 flex items-center justify-center">
                <div className="text-center text-gray-500">
                  <Camera className="w-12 h-12 mx-auto mb-4 opacity-50" />
                  <p>Generated image will appear here</p>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };
    
    // Main App Component
    const FUKGenerationUI = () => {
      const [activeTab, setActiveTab] = useState('image');
      const [config, setConfig] = useState(null);
      const [status, setStatus] = useState('loading');
      
      // Load config on mount
      useEffect(() => {
        loadConfig();
      }, []);
      
      const loadConfig = async () => {
        try {
          const [defaultsRes, modelsRes] = await Promise.all([
            fetch(`${API_URL}/config/defaults`),
            fetch(`${API_URL}/config/models`)
          ]);
          
          if (!defaultsRes.ok || !modelsRes.ok) {
            throw new Error('Failed to load config');
          }
          
          const defaults = await defaultsRes.json();
          const models = await modelsRes.json();
          
          setConfig({ defaults, models });
          setStatus('ready');
        } catch (error) {
          console.error('Failed to load config:', error);
          setStatus('error');
        }
      };
      
      if (status === 'loading') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white flex items-center justify-center">
            <div className="text-center">
              <Loader className="w-12 h-12 mx-auto mb-4 animate-spin text-purple-500" />
              <p className="text-gray-400">Loading FUK Generation Pipeline...</p>
            </div>
          </div>
        );
      }
      
      if (status === 'error') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white flex items-center justify-center">
            <div className="text-center max-w-md">
              <div className="text-red-500 mb-4">
                <svg className="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <h2 className="text-xl font-bold mb-2">Cannot Connect to Server</h2>
              <p className="text-gray-400 mb-4">
                Make sure the backend server is running on port 8000.
              </p>
              <pre className="text-left bg-gray-800 p-4 rounded text-sm overflow-x-auto">
python fuk_web_server.py
              </pre>
            </div>
          </div>
        );
      }
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white">
          {/* Header */}
          <header className="border-b border-gray-700 bg-gray-900/50 backdrop-blur-sm">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                    <Zap className="w-6 h-6" />
                  </div>
                  <div>
                    <h1 className="text-2xl font-bold">FUK Generation Pipeline</h1>
                    <p className="text-sm text-gray-400">Qwen Image Ã— Wan Video â€¢ v1.3</p>
                  </div>
                </div>
              </div>
            </div>
          </header>
          
          {/* Tabs */}
          <div className="border-b border-gray-700">
            <div className="max-w-7xl mx-auto px-6">
              <div className="flex gap-2">
                <TabButton
                  active={activeTab === 'image'}
                  onClick={() => setActiveTab('image')}
                  icon={<Camera className="w-4 h-4" />}
                  label="Image Generation"
                />
                <TabButton
                  active={activeTab === 'video'}
                  onClick={() => setActiveTab('video')}
                  icon={<Film className="w-4 h-4" />}
                  label="Video Generation"
                />
              </div>
            </div>
          </div>
          
          {/* Content */}
          <main className="max-w-7xl mx-auto px-6 py-8">
            {activeTab === 'image' && <ImageGenerationTab config={config} />}
            {activeTab === 'video' && (
              <div className="bg-gray-800/50 rounded-lg border border-gray-700 p-12 text-center">
                <Film className="w-12 h-12 mx-auto mb-4 opacity-50" />
                <p className="text-gray-400">Video generation UI coming soon...</p>
              </div>
            )}
          </main>
        </div>
      );
    };
    
    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<FUKGenerationUI />);
  </script>
</body>
</html>